<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ã‚ã—ã‚ã¨ã¨é‡Œ - ã¤ã¶ãƒŠãƒ“</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Zen Maru Gothic', sans-serif; background: #87CEEB; overflow: hidden; }
        header { background: #FFF; padding: 15px 30px; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.15); display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 100; }
        .logo { font-size: 24px; font-weight: bold; color: #FF9800; }
        nav { display: flex; gap: 15px; }
        .nav-btn { padding: 10px 20px; border-radius: 30px; text-decoration: none; color: #666; background: #FFF; transition: all 0.3s; }
        .nav-btn.active { background: linear-gradient(135deg, #FFB74D 0%, #FF9800 100%); color: white; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3); }
        #canvas { display: block; width: 100%; height: calc(100vh - 80px); }
        .info-panel { position: fixed; top: 100px; right: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 25px; padding: 20px; width: 320px; max-height: 70vh; overflow-y: auto; box-shadow: 0 8px 24px rgba(255, 152, 0, 0.2); display: none; }
        .panel-title { font-size: 20px; font-weight: bold; color: #FF9800; margin-bottom: 15px; }
        .ranking-item { background: #FFF3E0; border-radius: 15px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .rank { width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, #FFB74D 0%, #FF9800 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; }
        .pin-btn { background: linear-gradient(135deg, #FFB74D 0%, #FF9800 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; margin-top: 15px; width: 100%; font-family: 'Zen Maru Gothic', sans-serif; }
        .pin-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(255, 152, 0, 0.4); }
        .legend { position: fixed; top: 100px; left: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 25px; padding: 20px; box-shadow: 0 8px 24px rgba(255, 152, 0, 0.2); }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 14px; color: #5D4037; }
        .controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.95); border-radius: 25px; padding: 15px 30px; box-shadow: 0 8px 24px rgba(255, 152, 0, 0.2); }
        .control-text { color: #5D4037; font-size: 14px; text-align: center; }
        @keyframes shimmer { 0%, 100% { filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.6)); } 50% { filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.9)); } }
        @keyframes sparkle { 0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); } 50% { opacity: 0.6; transform: scale(1.3) rotate(180deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    </style>
</head>
<body>
    <header>
        <div class="logo">ğŸ’¬ ã¤ã¶ãƒŠãƒ“</div>
        <nav>
            <a href="home_tsubunavi.html" class="nav-btn">ğŸ  ãƒ›ãƒ¼ãƒ </a>
            <a href="forest_tsubunavi.html" class="nav-btn active">ğŸŒ² ã‚ã—ã‚ã¨ã¨é‡Œ</a>
            <a href="bonfire_premium.html" class="nav-btn">ğŸ”¥ å¤œã®ç„šç«åºƒå ´</a>
        </nav>
        <div style="font-weight: bold; color: #5D4037;">ç”°ä¸­ å¥å¤ª</div>
    </header>
    
    <canvas id="canvas"></canvas>
    
    <div class="info-panel" id="infoPanel">
        <div class="panel-title" id="panelTitle">ğŸ’¬ ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é‡Œ</div>
        <div style="margin-bottom: 15px; color: #666; font-size: 14px;" id="panelStatus"></div>
        <div style="font-weight: bold; margin-bottom: 10px; color: #5D4037;">ğŸ† ãƒã‚¤ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP5</div>
        <div id="rankingList"></div>
        <button class="pin-btn" onclick="pinVillage()">ğŸ“ ã“ã®é‡Œã‚’ç›®æ¨™ã«è¨­å®š</button>
    </div>
    
    <div class="legend">
        <div style="font-weight: bold; margin-bottom: 15px; color: #FF9800;">å‡¡ä¾‹</div>
        <div class="legend-item"><span style="font-size: 20px;">ğŸ§‘</span> ã‚ãªãŸ</div>
        <div class="legend-item"><span style="font-size: 20px;">ğŸ‘¤</span> å…¬é–‹ã•ã‚ŒãŸã‚ã—ã‚ã¨</div>
        <div class="legend-item"><span style="font-size: 20px;">ğŸ‘£</span> ã‚ã—ã‚ã¨</div>
        <div class="legend-item"><div style="width: 20px; height: 20px; border-radius: 50%; background: #FFB74D;"></div> é–‹æ‹“æ¸ˆã¿</div>
        <div class="legend-item"><div style="width: 20px; height: 20px; border-radius: 50%; background: #999;"></div> æœªé–‹æ‹“</div>
        <div class="legend-item"><span style="font-size: 20px;">ğŸ”¥</span> æœ€å¤§äººæ•°</div>
    </div>
    
    <div class="controls">
        <div class="control-text">ğŸ–±ï¸ ã‚¯ãƒªãƒƒã‚¯: é‡Œã‚’é¸æŠ | ESC: ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹</div>
    </div>
    
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight - 80;
        
        const villages = [
            { x: canvas.width * 0.5, y: canvas.height * 0.15, icon: 'ğŸ’¬', name: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', color: '#FFB74D', size: 90, unlocked: true, members: 45, requiredLevel: 0 },
            { x: canvas.width * 0.8, y: canvas.height * 0.3, icon: 'ğŸ§©', name: 'èª²é¡Œè§£æ±º', color: '#FF9800', size: 85, unlocked: false, members: 32, requiredLevel: 8 },
            { x: canvas.width * 0.85, y: canvas.height * 0.65, icon: 'ğŸ—ï¸', name: 'ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ', color: '#FFA726', size: 80, unlocked: false, members: 28, requiredLevel: 10 },
            { x: canvas.width * 0.2, y: canvas.height * 0.3, icon: 'ğŸ‘‘', name: 'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—', color: '#FFB74D', size: 75, unlocked: false, members: 18, requiredLevel: 12 },
            { x: canvas.width * 0.15, y: canvas.height * 0.65, icon: 'ğŸ’¡', name: 'ææ¡ˆåŠ›', color: '#FF9800', size: 85, unlocked: true, members: 38, requiredLevel: 0 }
        ];
        
        const rankings = {
            'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³': [
                { name: 'å±±ç”° å¤ªéƒ', points: 850 },
                { name: 'ä½è—¤ ç¾å’²', points: 720 },
                { name: 'éˆ´æœ¨ ä¸€éƒ', points: 680 },
                { name: 'ç”°ä¸­ èŠ±å­', points: 650 },
                { name: 'ä¼Šè—¤ å¥', points: 620 }
            ],
            'èª²é¡Œè§£æ±º': [
                { name: 'é«˜æ©‹ æ˜', points: 920 },
                { name: 'æ¸¡è¾º ç¾ç´€', points: 880 },
                { name: 'ä¸­æ‘ å¤§è¼”', points: 840 },
                { name: 'å°æ— çœŸç”±', points: 800 },
                { name: 'åŠ è—¤ èª ', points: 760 }
            ]
        };
        
        const maxVillage = villages.reduce((max, v) => v.members > max.members ? v : max);
        let selectedVillage = null;
        
        const footprints = [];
        
        // localStorageã‹ã‚‰ã‚ã—ã‚ã¨ã‚’èª­ã¿è¾¼ã¿
        function loadFootprints() {
            footprints.length = 0;
            
            // ãƒ›ãƒ¼ãƒ ã§ç”Ÿæˆã•ã‚ŒãŸã‚ã—ã‚ã¨ã‚’èª­ã¿è¾¼ã¿
            const savedReports = JSON.parse(localStorage.getItem('savedReports') || '{}');
            Object.values(savedReports).forEach(report => {
                // æ—¥å ±ã‹ã‚‰ã‚ã—ã‚ã¨ã‚’ç”Ÿæˆ
                const footprint = {
                    userId: 'user_12345',
                    userName: 'ç”°ä¸­ å¥å¤ª',
                    date: report.date,
                    title: report.title || 'APIè¨­è¨ˆã¨ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºã®é€²å±•',
                    activity: report.title,
                    text: report.content || 'ä»Šæ—¥ã¯APIè¨­è¨ˆæ›¸ã®ä½œæˆã‚’å®Œäº†ã—ã¾ã—ãŸã€‚è¨­è¨ˆæ®µéšã§ã®è©³ç´°ãªæ¤œè¨ãŒé‡è¦ã§ã‚ã‚‹ã“ã¨ã‚’å†èªè­˜ã—ã¾ã—ãŸã€‚',
                    skill: extractSkillFromReport(report),
                    emotion: 'ğŸ‘£',
                    isPositive: report.content.includes('é †èª¿') || report.content.includes('å®Œäº†') || report.content.includes('æˆåŠŸ'),
                    isNegative: report.content.includes('å›°é›£') || report.content.includes('å•é¡Œ') || report.content.includes('å¤±æ•—')
                };
                footprints.push(footprint);
            });
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚ã—ã‚ã¨ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼‰
            if (Object.keys(savedReports).length === 0) {
                const defaultFootprints = [
                    {
                        userId: 'user_12345',
                        userName: 'ç”°ä¸­ å¥å¤ª',
                        date: '2024-01-15',
                        title: 'APIè¨­è¨ˆã¨ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºã®é€²å±•',
                        activity: 'APIè¨­è¨ˆæ›¸ã®ä½œæˆã‚’å®Œäº†',
                        text: 'ä»Šæ—¥ã¯APIè¨­è¨ˆæ›¸ã®ä½œæˆã‚’å®Œäº†ã—ã¾ã—ãŸã€‚è¨­è¨ˆæ®µéšã§ã®è©³ç´°ãªæ¤œè¨ãŒé‡è¦ã§ã‚ã‚‹ã“ã¨ã‚’å†èªè­˜ã—ã¾ã—ãŸã€‚ãƒãƒ¼ãƒ ã¨ã®é€£æºã‚‚ã‚¹ãƒ ãƒ¼ã‚ºã«é€²ã¿ã€æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã«å‘ã‘ãŸæº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚',
                        skill: 'ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ',
                        emotion: 'ğŸ‘£',
                        isPositive: true
                    },
                    {
                        userId: 'user_12345',
                        userName: 'ç”°ä¸­ å¥å¤ª',
                        date: '2024-01-14',
                        title: 'ãƒãƒ¼ãƒ ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–ã®ä¸€æ—¥',
                        activity: 'ãƒãƒ¼ãƒ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ã®è­°è«–',
                        text: 'ãƒãƒ¼ãƒ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§æ´»ç™ºãªè­°è«–ãŒã§ãã¾ã—ãŸã€‚ãƒ¡ãƒ³ãƒãƒ¼ã¨ã®æ„è¦‹äº¤æ›ã‚’é€šã˜ã¦ã€æ–°ã—ã„è¦–ç‚¹ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ–¹å‘æ€§ãŒã‚ˆã‚Šæ˜ç¢ºã«ãªã‚Šã¾ã—ãŸã€‚',
                        skill: 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³',
                        emotion: 'ğŸ‘£',
                        isPositive: true
                    }
                ];
                defaultFootprints.forEach(fp => footprints.push(fp));
            }
            
            // å…¬é–‹ã•ã‚ŒãŸã‚ã—ã‚ã¨ã‚’èª­ã¿è¾¼ã¿
            const publicFootprints = JSON.parse(localStorage.getItem('publicFootprints') || '[]');
            publicFootprints.forEach(fp => {
                if (fp.isPublic && fp.userId !== 'user_12345') {
                    footprints.push(fp);
                }
            });
            
            // å…¬é–‹ã•ã‚ŒãŸä»–äººã®ã‚ã—ã‚ã¨ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ï¼‰
            const approvals = JSON.parse(localStorage.getItem('footprintApprovals') || '{}');
            const approvedUsers = Object.keys(approvals).filter(key => approvals[key].approved);
            
            if (approvedUsers.length > 0) {
                const sharedFootprints = [
                    {"userId": "user_67890", "userName": "å±±ç”° å¤ªéƒ", "date": "2023-01-15", "activity": "æˆé•·å®Ÿæ„ŸãŒãªãã¦ä¸å®‰ã ã£ãŸ", "skill": "ãƒ¡ãƒ³ã‚¿ãƒ«ã‚±ã‚¢", "emotion": "ğŸ˜°", "isNegative": true, "phase": "è‹¦æ‚©æœŸ"},
                    {"userId": "user_67890", "userName": "å±±ç”° å¤ªéƒ", "date": "2023-03-20", "activity": "å°ã•ãªç›®æ¨™ã‚’è¨­å®šã—ã¦ã¿ãŸ", "skill": "ç›®æ¨™è¨­å®š", "emotion": "ğŸ’ª", "isPositive": true, "phase": "æ¨¡ç´¢æœŸ"},
                    {"userId": "user_67890", "userName": "å±±ç”° å¤ªéƒ", "date": "2023-06-10", "activity": "é”æˆæ„ŸãŒå¯è¦–åŒ–ã•ã‚Œã¦å‰å‘ãã«ãªã‚ŒãŸ", "skill": "ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³", "emotion": "ğŸŒŸ", "isPositive": true, "phase": "æˆé•·æœŸ"},
                    {"userId": "user_67890", "userName": "å±±ç”° å¤ªéƒ", "date": "2023-09-01", "activity": "å®šæœŸçš„ãªæŒ¯ã‚Šè¿”ã‚Šã§æˆé•·ã‚’å®Ÿæ„Ÿã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸ", "skill": "è‡ªå·±ç®¡ç†", "emotion": "ğŸ‰", "isPositive": true, "phase": "å…‹æœæœŸ"}
                ];
                sharedFootprints.forEach(fp => footprints.push(fp));
            }
        }
        
        // æ—¥å ±ã‹ã‚‰ã‚¹ã‚­ãƒ«ã‚’æŠ½å‡º
        function extractSkillFromReport(report) {
            const content = report.content.toLowerCase();
            if (content.includes('api') || content.includes('è¨­è¨ˆ')) return 'ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ';
            if (content.includes('ãƒãƒ¼ãƒ ') || content.includes('ä¼šè­°')) return 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³';
            if (content.includes('å­¦ç¿’') || content.includes('èª¿æŸ»')) return 'æŠ€è¡“å­¦ç¿’';
            if (content.includes('ææ¡ˆ') || content.includes('ã‚¢ã‚¤ãƒ‡ã‚¢')) return 'ææ¡ˆåŠ›';
            if (content.includes('è§£æ±º') || content.includes('èª²é¡Œ')) return 'èª²é¡Œè§£æ±º';
            return 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }
        
        // æ—¥å ±ã‹ã‚‰ã‚¹ã‚­ãƒ«ã‚’æŠ½å‡º
        function extractSkillFromReport(report) {
            const content = report.content.toLowerCase();
            if (content.includes('api') || content.includes('è¨­è¨ˆ')) return 'ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ';
            if (content.includes('ãƒãƒ¼ãƒ ') || content.includes('ä¼šè­°')) return 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³';
            if (content.includes('å­¦ç¿’') || content.includes('èª¿æŸ»')) return 'æŠ€è¡“å­¦ç¿’';
            if (content.includes('ææ¡ˆ') || content.includes('ã‚¢ã‚¤ãƒ‡ã‚¢')) return 'ææ¡ˆåŠ›';
            if (content.includes('è§£æ±º') || content.includes('èª²é¡Œ')) return 'èª²é¡Œè§£æ±º';
            return 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }
        
        loadFootprints();
        
        const trees = [
            { x: canvas.width * 0.1, y: canvas.height * 0.15 },
            { x: canvas.width * 0.15, y: canvas.height * 0.3 },
            { x: canvas.width * 0.12, y: canvas.height * 0.55 },
            { x: canvas.width * 0.9, y: canvas.height * 0.2 },
            { x: canvas.width * 0.85, y: canvas.height * 0.4 },
            { x: canvas.width * 0.92, y: canvas.height * 0.8 },
            { x: canvas.width * 0.5, y: canvas.height * 0.1 },
            { x: canvas.width * 0.35, y: canvas.height * 0.85 },
            { x: canvas.width * 0.65, y: canvas.height * 0.15 }
        ];
        
        function drawGround() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#8BC34A');
            gradient.addColorStop(0.5, '#7CB342');
            gradient.addColorStop(1, '#689F38');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'rgba(139, 195, 74, 0.3)';
            for (let i = 0; i < 200; i++) {
                ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
            }
        }
        
        function drawFootprints() {
            // ä¸­å¿ƒï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ã®ä½ç½®
            const centerX = canvas.width * 0.5;
            const centerY = canvas.height * 0.5;
            
            // ã‚¹ã‚­ãƒ«ã”ã¨ã«ã‚ã—ã‚ã¨ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const footprintsBySkill = {};
            footprints.forEach(fp => {
                if (!footprintsBySkill[fp.skill]) {
                    footprintsBySkill[fp.skill] = [];
                }
                footprintsBySkill[fp.skill].push(fp);
            });
            
            // å„é‡Œã«å‘ã‹ã†ã‚ã—ã‚ã¨ã‚’æç”»
            villages.forEach(village => {
                const skillFootprints = footprintsBySkill[village.name] || [];
                
                skillFootprints.forEach((fp, index) => {
                    // ä¸­å¿ƒã‹ã‚‰é‡Œã«å‘ã‹ã†ãƒ‘ã‚¹ã‚’è¨ˆç®—
                    const progress = (index + 1) / (skillFootprints.length + 1);
                    const x = centerX + (village.x - centerX) * progress;
                    const y = centerY + (village.y - centerY) * progress;
                    
                    // æ„Ÿæƒ…ã«ã‚ˆã‚‹è‰²å¤‰åŒ–
                    let color = '#FFB74D';
                    if (fp.isPositive) color = '#81C784';
                    if (fp.isNegative) color = '#EF5350';
                    
                    // å…¬é–‹ã•ã‚ŒãŸã‚ã—ã‚ã¨ã¯ç‰¹åˆ¥ãªè¡¨ç¤º
                    if (fp.isPublic && fp.userId !== 'user_12345') {
                        // å…‰ã‚‹è¼ªã‚’è¿½åŠ 
                        ctx.strokeStyle = '#FFD700';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.arc(x, y, 25, 0, Math.PI * 2);
                        ctx.stroke();
                        
                        // å…¬é–‹ãƒãƒ¼ã‚¯
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('ğŸ‘¤', x - 15, y - 15);
                    }
                    
                    // å…‰ã‚‹å††
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(x, y, 18, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // è¶³è·¡çµµæ–‡å­—
                    ctx.font = '22px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(fp.emotion || 'ğŸ‘£', x, y);
                    
                    // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªã‚¨ãƒªã‚¢ã‚’ä¿å­˜
                    fp.x = x;
                    fp.y = y;
                });
            });
        }
        
        let time = 0;
        
        function drawVillages() {
            time++;
            villages.forEach(village => {
                if (village.unlocked) {
                    // é–‹æ‹“æ¸ˆã¿ã®é‡Œ
                    const gradient = ctx.createRadialGradient(village.x, village.y, 0, village.x, village.y, village.size);
                    gradient.addColorStop(0, village.color + 'CC');
                    gradient.addColorStop(0.7, village.color + '66');
                    gradient.addColorStop(1, 'transparent');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(village.x, village.y, village.size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = village.color;
                    ctx.beginPath();
                    ctx.arc(village.x, village.y, village.size * 0.7, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.font = `${village.size * 0.5}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.fillText(village.icon, village.x, village.y);
                    
                    ctx.font = `bold ${village.size * 0.2}px "Zen Maru Gothic"`;
                    ctx.fillStyle = '#5D4037';
                    ctx.fillText(village.name, village.x, village.y + village.size * 0.8);
                    ctx.fillText('ã®é‡Œ', village.x, village.y + village.size * 1.1);
                } else {
                    // æœªé–‹æ‹“ã®é‡Œï¼ˆã‚ãã‚ããƒ‡ã‚¶ã‚¤ãƒ³ï¼‰
                    // è™¹è‰²ã®å…‰ã®è¼ª
                    for (let i = 0; i < 3; i++) {
                        const radius = village.size + 20 + i * 15 + Math.sin(time * 0.03 + i) * 10;
                        const hue = (time + i * 60) % 360;
                        ctx.strokeStyle = `hsla(${hue}, 80%, 60%, ${0.4 - i * 0.1})`;
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.arc(village.x, village.y, radius, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                    
                    // ã‚­ãƒ©ã‚­ãƒ©æ˜Ÿ
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI * 2 / 6) * i + time * 0.02;
                        const dist = village.size + 25 + Math.sin(time * 0.04 + i) * 10;
                        const sx = village.x + Math.cos(angle) * dist;
                        const sy = village.y + Math.sin(angle) * dist;
                        const sparkleSize = 15 + Math.sin(time * 0.05 + i) * 5;
                        ctx.save();
                        ctx.translate(sx, sy);
                        ctx.rotate(time * 0.03 + i);
                        ctx.font = `${sparkleSize}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.shadowColor = '#FFD700';
                        ctx.shadowBlur = 15;
                        ctx.fillText('âœ¨', 0, 0);
                        ctx.restore();
                    }
                    
                    // ã‚°ãƒ¬ãƒ¼ã®ãƒ™ãƒ¼ã‚¹
                    const gradient = ctx.createRadialGradient(village.x, village.y, 0, village.x, village.y, village.size);
                    gradient.addColorStop(0, '#BDBDBD');
                    gradient.addColorStop(0.7, '#9E9E9E66');
                    gradient.addColorStop(1, 'transparent');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(village.x, village.y, village.size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#999';
                    ctx.shadowColor = '#FFD700';
                    ctx.shadowBlur = 20 + Math.sin(time * 0.05) * 10;
                    ctx.beginPath();
                    ctx.arc(village.x, village.y, village.size * 0.7, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    
                    // ç‚¹ç·šã®æ 
                    ctx.strokeStyle = '#FFD700';
                    ctx.lineWidth = 4;
                    ctx.setLineDash([10, 10]);
                    ctx.lineDashOffset = -time * 0.5;
                    ctx.beginPath();
                    ctx.arc(village.x, village.y, village.size * 0.7, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // ç–‘å•ç¬¦ï¼ˆãƒã‚¦ãƒ³ã‚¹ï¼‰
                    const bounce = Math.sin(time * 0.04) * 8;
                    ctx.save();
                    ctx.translate(village.x, village.y + bounce);
                    ctx.rotate(Math.sin(time * 0.03) * 0.1);
                    ctx.font = `${village.size * 0.6}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = '#FFD700';
                    ctx.shadowBlur = 25;
                    ctx.fillText('â“', 0, 0);
                    ctx.restore();
                    ctx.shadowBlur = 0;
                    
                    // åå‰
                    ctx.font = `bold ${village.size * 0.2}px "Zen Maru Gothic"`;
                    ctx.fillStyle = '#999';
                    ctx.fillText('???', village.x, village.y + village.size * 0.8);
                    ctx.fillText('ã®é‡Œ', village.x, village.y + village.size * 1.1);
                    
                    // å¿…è¦ãƒ¬ãƒ™ãƒ«
                    ctx.font = `bold ${village.size * 0.18}px "Zen Maru Gothic"`;
                    ctx.fillStyle = '#FFD700';
                    ctx.shadowColor = '#FFD700';
                    ctx.shadowBlur = 10;
                    ctx.fillText(`ğŸ”’ Lv.${village.requiredLevel}ã§é–‹æ”¾`, village.x, village.y + village.size * 1.4);
                    ctx.shadowBlur = 0;
                }
                
                if (village === maxVillage && village.unlocked) {
                    ctx.font = `${village.size * 0.4}px Arial`;
                    ctx.fillText('ğŸ”¥', village.x + village.size * 0.6, village.y - village.size * 0.6);
                }
            });
        }
        
        function drawTrees() {
            trees.forEach(tree => {
                ctx.font = '40px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸŒ²', tree.x, tree.y);
            });
        }
        
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawGround();
            drawTrees();
            drawFootprints();
            drawVillages();
            drawPlayer();
            drawClouds();
            
            requestAnimationFrame(render);
        }
        
        function drawPlayer() {
            const centerX = canvas.width * 0.5;
            const centerY = canvas.height * 0.5;
            
            // å½±
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath();
            ctx.ellipse(centerX, centerY + 25, 20, 8, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
            ctx.font = 'bold 50px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowColor = 'rgba(255, 152, 0, 0.5)';
            ctx.shadowBlur = 15;
            ctx.fillText('ğŸ§‘', centerX, centerY);
            ctx.shadowBlur = 0;
            
            // åå‰ãƒ—ãƒ¬ãƒ¼ãƒˆ
            ctx.fillStyle = 'rgba(255, 152, 0, 0.9)';
            ctx.shadowColor = 'rgba(255, 152, 0, 0.5)';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.roundRect(centerX - 50, centerY - 60, 100, 30, 15);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            ctx.font = 'bold 16px "Zen Maru Gothic"';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.fillText('ã‚ãªãŸ', centerX, centerY - 45);
        }
        
        function showVillageInfo(village) {
            selectedVillage = village;
            document.getElementById('panelTitle').textContent = `${village.icon} ${village.name}ã®é‡Œ`;
            
            const statusDiv = document.getElementById('panelStatus');
            if (village.unlocked) {
                statusDiv.innerHTML = `äººæ•°: ${village.members}äºº<br><span style="font-weight: bold; color: #FF9800;">é–‹æ‹“æ¸ˆã¿</span>`;
            } else {
                statusDiv.innerHTML = `ã‚ã¨15ptã§ã€Œé‡Œã®è€…ã€ã«ãªã‚Œã¾ã™ï¼<br><span style="font-weight: bold; color: #999;">æœªé–‹æ‹“</span>`;
            }
            
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';
            const villageRanking = rankings[village.name] || [];
            villageRanking.forEach((person, index) => {
                const item = document.createElement('div');
                item.className = 'ranking-item';
                item.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="rank">${index + 1}</div>
                        <div style="font-weight: bold; font-size: 14px; color: #5D4037;">${person.name}</div>
                    </div>
                    <div style="font-weight: bold; color: #FF9800;">${person.points}pt</div>
                `;
                rankingList.appendChild(item);
            });
            
            document.getElementById('infoPanel').style.display = 'block';
        }
        
        function pinVillage() {
            if (selectedVillage) {
                localStorage.setItem('pinnedVillage', JSON.stringify({
                    name: selectedVillage.name,
                    icon: selectedVillage.icon
                }));
                alert(`ğŸ“ ${selectedVillage.name}ã®é‡Œã‚’ç›®æ¨™ã«è¨­å®šã—ã¾ã—ãŸï¼\nãƒ›ãƒ¼ãƒ ç”»é¢ã®ã€Œä»Šã®ç›®æ¨™ã€ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚`);
            }
        }
        
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            
            // é‡Œã‚’ã‚¯ãƒªãƒƒã‚¯
            villages.forEach(village => {
                const dist = Math.sqrt((clickX - village.x) ** 2 + (clickY - village.y) ** 2);
                if (dist < village.size) {
                    showVillageInfo(village);
                }
            });
            
            // ã‚ã—ã‚ã¨ã‚’ã‚¯ãƒªãƒƒã‚¯
            footprints.forEach(fp => {
                if (fp.x && fp.y) {
                    const dist = Math.sqrt((clickX - fp.x) ** 2 + (clickY - fp.y) ** 2);
                    if (dist < 20) {
                        showFootprintDetail(fp);
                    }
                }
            });
        });
        
        function showFootprintDetail(fp) {
            if (fp.userId === 'user_12345') {
                // è‡ªåˆ†ã®ã‚ã—ã‚ã¨
                const tooltip = document.createElement('div');
                tooltip.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px;">${fp.emotion} ${fp.date}</div>
                    <div style="font-weight: bold; margin-bottom: 8px; color: #FF9800;">${fp.title}</div>
                    <div style="margin-bottom: 8px;">${fp.text}</div>
                    <div style="font-size: 12px; color: #FF9800;">ã‚¹ã‚­ãƒ«: ${fp.skill}</div>
                `;
                tooltip.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.98); color: #5D4037; padding: 20px 30px; border-radius: 20px; font-size: 14px; z-index: 9999; box-shadow: 0 20px 60px rgba(255, 152, 0, 0.5); border: 3px solid #FFB74D; max-width: 400px; line-height: 1.6;';
                document.body.appendChild(tooltip);
                setTimeout(() => tooltip.remove(), 4000);
            } else {
                // ä»–äººã®ã‚ã—ã‚ã¨ - è»Œè·¡ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’è¡¨ç¤º
                showJourneyThread(fp.userName, fp.userId);
            }
        }
        
        function showJourneyThread(userName, userId) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 30px; padding: 40px; max-width: 700px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative;';
            
            // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®è»Œè·¡
            const journeyDatabase = {
                'user_67890': {
                    challenge: 'æˆé•·å®Ÿæ„ŸãŒãªã„',
                    steps: [
                        {
                            timestamp: "2023-01-15",
                            phase: "è‹¦æ‚©æœŸ",
                            content: "æ¯æ—¥åŒã˜ã‚ˆã†ãªä½œæ¥­ã®ç¹°ã‚Šè¿”ã—ã§ã€æœ¬å½“ã«æˆé•·ã—ã¦ã„ã‚‹ã®ã‹åˆ†ã‹ã‚‰ãªããªã£ãŸ",
                            action: "å…ˆè¼©ã«ç›¸è«‡ã—ã¦ã¿ãŸ",
                            insight: "åŒã˜æ‚©ã¿ã‚’æŒã¤äººãŒå¤šã„ã“ã¨ã‚’çŸ¥ã‚Šã€å°‘ã—å®‰å¿ƒã—ãŸ"
                        },
                        {
                            timestamp: "2023-02-20",
                            phase: "æ¨¡ç´¢æœŸ",
                            content: "å°ã•ãªç›®æ¨™ã‚’è¨­å®šã—ã¦ã¿ãŸãŒã€é”æˆæ„Ÿã‚’æ„Ÿã˜ã«ãã‹ã£ãŸ",
                            action: "é€±å˜ä½ã§ã®æŒ¯ã‚Šè¿”ã‚Šã‚’å§‹ã‚ãŸ",
                            insight: "å°ã•ãªå¤‰åŒ–ã§ã‚‚è¨˜éŒ²ã™ã‚‹ã“ã¨ã§é€²æ­©ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸ"
                        },
                        {
                            timestamp: "2023-04-10",
                            phase: "æˆé•·æœŸ",
                            content: "æŒ¯ã‚Šè¿”ã‚Šã‚’ç¶šã‘ã‚‹ã“ã¨ã§ã€è‡ªåˆ†ã®å¤‰åŒ–ã«æ°—ã¥ã‘ã‚‹ã‚ˆã†ã«ãªã£ãŸ",
                            action: "å¾Œè¼©ã«çµŒé¨“ã‚’ã‚·ã‚§ã‚¢ã—ãŸ",
                            insight: "äººã«æ•™ãˆã‚‹ã“ã¨ã§è‡ªåˆ†ã®æˆé•·ã‚’å®Ÿæ„Ÿã§ããŸ"
                        },
                        {
                            timestamp: "2023-06-01",
                            phase: "å…‹æœæœŸ",
                            content: "å®šæœŸçš„ãªæŒ¯ã‚Šè¿”ã‚ŠãŒç¿’æ…£ã«ãªã‚Šã€æˆé•·ã‚’å®Ÿæ„Ÿã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸ",
                            action: "ãƒ¡ãƒ³ã‚¿ãƒ¼ã¨ã—ã¦ä»–ã®äººã‚’ã‚µãƒãƒ¼ãƒˆã—å§‹ã‚ãŸ",
                            insight: "æˆé•·ã¯æ—¥ã€…ã®ç©ã¿é‡ã­ã§ã‚ã‚Šã€ä»–è€…ã‚’åŠ©ã‘ã‚‹ã“ã¨ã§ã•ã‚‰ã«æˆé•·ã§ãã‚‹"
                        }
                    ]
                },
                'user_11111': {
                    challenge: 'ãƒãƒ¼ãƒ ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³',
                    steps: [
                        {
                            timestamp: "2023-03-01",
                            phase: "è‹¦æ‚©æœŸ",
                            content: "ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã¨ã®æ„è¦‹ã®é£Ÿã„é•ã„ãŒå¤šãã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé€²ã¾ãªã„",
                            action: "1on1ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ææ¡ˆã—ãŸ",
                            insight: "ç›¸æ‰‹ã®ç«‹å ´ã‚’ç†è§£ã™ã‚‹ã“ã¨ã®é‡è¦æ€§ã«æ°—ã¥ã„ãŸ"
                        },
                        {
                            timestamp: "2023-04-15",
                            phase: "æ¨¡ç´¢æœŸ",
                            content: "ç©æ¥µçš„ã«è³ªå•ã™ã‚‹ã‚ˆã†ã«ã—ãŸãŒã€ã¾ã è·é›¢æ„Ÿã‚’æ„Ÿã˜ã‚‹",
                            action: "ãƒãƒ¼ãƒ ãƒ“ãƒ«ãƒ‡ã‚£ãƒ³ã‚°æ´»å‹•ã‚’ä¼ç”»ã—ãŸ",
                            insight: "ä»•äº‹ä»¥å¤–ã®äº¤æµã‚‚å¤§åˆ‡ã ã¨å­¦ã‚“ã "
                        },
                        {
                            timestamp: "2023-06-20",
                            phase: "æˆé•·æœŸ",
                            content: "ãƒãƒ¼ãƒ ã®é›°å›²æ°—ãŒè‰¯ããªã‚Šã€æ´»ç™ºãªè­°è«–ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸ",
                            action: "ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ«ã‚’å­¦ã‚“ã ",
                            insight: "è‰¯ã„ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯æŠ€è¡“ã¨ã—ã¦å­¦ã¹ã‚‹"
                        },
                        {
                            timestamp: "2023-08-10",
                            phase: "å…‹æœæœŸ",
                            content: "ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ã¨ã—ã¦ä¿¡é ¼ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸ",
                            action: "ä»–ã®ãƒãƒ¼ãƒ ã«ã‚‚ãƒã‚¦ãƒã‚¦ã‚’å…±æœ‰ã—ãŸ",
                            insight: "è‰¯ã„ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯çµ„ç¹”å…¨ä½“ã«æ³¢åŠã™ã‚‹"
                        }
                    ]
                }
            };
            
            const journeyData = journeyDatabase[userId] || journeyDatabase['user_67890'];
            
            content.innerHTML = `
                <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 20px; right: 25px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">Ã—</button>
                <div style="font-size: 24px; font-weight: bold; color: #FF9800; margin-bottom: 25px;">ğŸŒ± ${userName}ã•ã‚“ã®æˆé•·ã®è»Œè·¡</div>
                <div style="font-size: 14px; color: #666; margin-bottom: 20px;">ã€Œ${journeyData.challenge}ã€ã¨ã„ã†èª²é¡Œã‚’ã©ã†ä¹—ã‚Šè¶ŠãˆãŸã‹</div>
                ${journeyData.steps.map(step => `
                    <div style="background: #FFFBF5; border-radius: 20px; padding: 20px; margin-bottom: 20px; border-left: 5px solid ${getPhaseColor(step.phase)};">
                        <div style="color: #999; font-size: 13px; margin-bottom: 5px;">ğŸ“… ${step.timestamp}</div>
                        <div style="display: inline-block; background: ${getPhaseColor(step.phase)}; color: white; padding: 5px 15px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-bottom: 10px;">${step.phase}</div>
                        <div style="color: #5D4037; line-height: 1.6; margin-bottom: 10px;">${step.content}</div>
                        <div style="color: #1976D2; margin: 8px 0;">ğŸ’¡ ${step.action}</div>
                        <div style="color: #388E3C; margin: 8px 0;">âœ¨ ${step.insight}</div>
                    </div>
                `).join('')}
                <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid #FFE0B2; color: #FF9800; font-weight: bold;">
                    ğŸ‘ ã‚ãªãŸã‚‚ãã£ã¨ä¹—ã‚Šè¶Šãˆã‚‰ã‚Œã¾ã™ï¼
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        function getPhaseColor(phase) {
            switch(phase) {
                case 'è‹¦æ‚©æœŸ': return '#EF5350';
                case 'æ¨¡ç´¢æœŸ': return '#FFA726';
                case 'æˆé•·æœŸ': return '#66BB6A';
                case 'å…‹æœæœŸ': return '#42A5F5';
                default: return '#FFB74D';
            }
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('infoPanel').style.display = 'none';
            }
        });
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 80;
            render();
        });
        
        render();
    </script>
</body>
</html>
